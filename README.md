# üé® Printify Service MalicknND

Microservice Node.js/Express pour g√©rer l'impression d'images g√©n√©r√©es par IA via l'API Printify.

## üöÄ Fonctionnalit√©s

### üéØ Cycle complet d'impression IA
- **Upload d'images IA** depuis Supabase vers Printify
- **Cr√©ation de produits personnalis√©s** (T-shirts, mugs, etc.)
- **Calcul automatique des prix** avec marge configurable
- **Gestion des commandes** avec livraison automatique
- **Pr√©visualisation** avant cr√©ation r√©elle

### üîê S√©curit√© & Auth
- Authentification **Clerk JWT** s√©curis√©e
- Rate limiting intelligent
- Validation des donn√©es robuste
- CORS configur√© pour production

### üí∞ Gestion des prix
- Application automatique de marges (50% par d√©faut)
- Conversion EUR/USD
- Calcul des profits en temps r√©el
- Simulation de prix avant cr√©ation

## üì¶ Installation

```bash
# Cloner le repository
git clone https://github.com/your-username/printify-service-malicknnd.git
cd printify-service-malicknnd

# Installer les d√©pendances
npm install

# Copier et configurer l'environnement
cp .env.example .env
# √âditer .env avec vos cl√©s API
```

## ‚öôÔ∏è Configuration

### Variables d'environnement requises

```bash
# Printify (OBLIGATOIRE)
PRINTIFY_API_KEY=your_printify_api_key
PRINTIFY_SHOP_ID=your_shop_id

# Clerk (optionnel en dev)
CLERK_JWKS_URL=https://your-domain.clerk.accounts.dev/.well-known/jwks.json
CLERK_ISSUER=https://your-domain.clerk.accounts.dev

# Configuration
PORT=3001
NODE_ENV=development
DEFAULT_MARGIN_PERCENT=50
```

### Obtenir vos cl√©s Printify

1. Cr√©ez un compte sur [Printify](https://printify.com)
2. Allez dans **My Profile ‚Üí Connections**
3. G√©n√©rez un **Personal Access Token**
4. Trouvez votre **Shop ID** dans l'URL de votre boutique

## üèÉ‚Äç‚ôÇÔ∏è D√©marrage

```bash
# Mode d√©veloppement (avec nodemon)
npm run dev

# Mode production
npm start

# Le service sera disponible sur http://localhost:3001
```

## üìö Documentation API

### üåê Endpoints publics

| M√©thode | Endpoint | Description |
|---------|----------|-------------|
| `GET` | `/api/printify/health` | √âtat du service |
| `GET` | `/api/printify/blueprints` | Liste des mod√®les de produits |
| `GET` | `/api/printify/blueprints/:id` | D√©tails d'un mod√®le |
| `GET` | `/api/printify/variants` | Variants (couleurs/tailles) |

### üîí Endpoints prot√©g√©s (Auth Clerk requis)

#### Upload d'images
```bash
POST /api/printify/upload
Authorization: Bearer YOUR_CLERK_JWT

{
  "imageUrl": "https://your-supabase.com/storage/v1/object/public/images/ai-image.png",
  "fileName": "mon-design-ia.png"
}
```

#### Cr√©ation de produit
```bash
POST /api/printify/product/create
Authorization: Bearer YOUR_CLERK_JWT

{
  "title": "T-shirt Design IA",
  "description": "T-shirt avec design g√©n√©r√© par IA",
  "blueprintId": 5,
  "printProviderId": 1,
  "variants": [
    {
      "id": 17887,
      "price": 2000,
      "is_enabled": true,
      "is_default": true
    }
  ],
  "printAreas": [
    {
      "variant_ids": [17887],
      "placeholders": [
        {
          "position": "front",
          "images": [
            {
              "id": "YOUR_UPLOADED_IMAGE_ID",
              "x": 0.5,
              "y": 0.5,
              "scale": 1,
              "angle": 0
            }
          ]
        }
      ]
    }
  ],
  "margin": 50
}
```

#### Cr√©ation de commande
```bash
POST /api/printify/order/create
Authorization: Bearer YOUR_CLERK_JWT

{
  "externalId": "order-123",
  "lineItems": [
    {
      "product_id": "YOUR_PRODUCT_ID",
      "variant_id": 17887,
      "quantity": 1
    }
  ],
  "shippingMethod": 1,
  "addressTo": {
    "first_name": "John",
    "last_name": "Doe",
    "email": "john@example.com",
    "country": "US",
    "address1": "123 Main St",
    "city": "New York",
    "zip": "10001"
  }
}
```

## üõ† Flux d'utilisation typique

### 1. Upload d'une image IA
```javascript
const uploadResponse = await fetch('/api/printify/upload', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${clerkToken}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    imageUrl: 'https://your-supabase-bucket.com/ai-image.png',
    fileName: 'design-unique.png'
  })
});

const { data: uploadedImage } = await uploadResponse.json();
console.log('Image ID:', uploadedImage.id);
```

### 2. Pr√©visualisation du produit
```javascript
const previewResponse = await fetch('/api/printify/product/preview', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${clerkToken}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    title: 'Mon T-shirt IA',
    blueprintId: 5,
    printProviderId: 1,
    variantIds: [17887],
    imageId: uploadedImage.id,
    margin: 60
  })
});

const { data: preview } = await previewResponse.json();
console.log('Prix calcul√©:', preview.pricing.averagePrice);
```

### 3. Cr√©ation du produit
```javascript
const productResponse = await fetch('/api/printify/product/create', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${clerkToken}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    title: 'Mon T-shirt IA',
    description: 'Design unique g√©n√©r√© par intelligence artificielle',
    blueprintId: 5,
    printProviderId: 1,
    variants: [
      { id: 17887, price: 2500, is_enabled: true, is_default: true }
    ],
    printAreas: [{
      variant_ids: [17887],
      placeholders: [{
        position: 'front',
        images: [{
          id: uploadedImage.id,
          x: 0.5, y: 0.5, scale: 1, angle: 0
        }]
      }]
    }],
    margin: 60
  })
});

const { data: product } = await productResponse.json();
```

### 4. Commande apr√®s paiement
```javascript
// Apr√®s validation du paiement Stripe par exemple
const orderResponse = await fetch('/api/printify/order/create', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${clerkToken}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    externalId: `order-${Date.now()}`,
    lineItems: [{
      product_id: product.id,
      variant_id: 17887,
      quantity: 1
    }],
    shippingMethod: 1,
    addressTo: customerAddress
  })
});
```

## üîß Calculs de prix

### Marge automatique
Le service applique automatiquement une marge configurable :

```javascript
// Co√ªt Printify: 8.00‚Ç¨
// Marge: 50%
// Prix de vente: 12.00‚Ç¨
// Profit: 4.00‚Ç¨

GET /api/printify/price/with-margin?variantId=17887&margin=50&currency=EUR
```

### Simulation de produit complet
```javascript
POST /api/printify/price/simulate
{
  "blueprintId": 5,
  "providerId": 1,
  "variantIds": [17887, 17888],
  "quantity": 1,
  "margin": 60,
  "currency": "EUR",
  "includeShipping": true
}
```

## üèó Architecture

```
printify-service-malicknnd/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ app.js                 # üöÄ Serveur Express principal
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ printify.js        # ‚öôÔ∏è Configuration Printify + Axios
‚îÇ   ‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ auth.js            # üîê Authentification Clerk JWT
‚îÇ   ‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ uploadController.js    # üì§ Upload d'images
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ productController.js   # üëï Gestion des produits
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ orderController.js     # üì¶ Gestion des commandes
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ catalogController.js   # üìö Catalogue Printify
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ priceController.js     # üí∞ Calculs de prix
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ shopController.js      # üè™ Gestion du shop
‚îÇ   ‚îî‚îÄ‚îÄ routes/
‚îÇ       ‚îî‚îÄ‚îÄ printify.js        # üõ£Ô∏è Routes API centralis√©es
‚îú‚îÄ‚îÄ .env                       # üîë Variables d'environnement
‚îú‚îÄ‚îÄ package.json
‚îî‚îÄ‚îÄ README.md
```

## üß™ Tests et d√©bogage

### Health check
```bash
curl http://localhost:3001/api/printify/health
```

### Test d'authentification
```bash
curl -H "Authorization: Bearer YOUR_CLERK_JWT" \
     http://localhost:3001/api/printify/shop/info
```

### Logs de d√©bogage
Le service affiche des logs d√©taill√©s en mode d√©veloppement :
```
üî• [UPLOAD] Nouvel upload pour utilisateur: user_123
üì§ [PRINTIFY API] POST /uploads/images.json
‚úÖ [UPLOAD] Image upload√©e avec succ√®s
üÜî [UPLOAD] ID Printify: 5f7d8e9a1b2c3d4e5f6g7h8i
```

## üö® Gestion des erreurs

Le service retourne des erreurs structur√©es :

```javascript
{
  "success": false,
  "error": "Description de l'erreur",
  "code": "ERROR_CODE",
  "details": "D√©tails suppl√©mentaires (dev uniquement)"
}
```

### Codes d'erreur courants
- `MISSING_TOKEN` : Token d'authentification manquant
- `INVALID_PRODUCT_DATA` : Donn√©es de produit invalides
- `PRINTIFY_UPLOAD_ERROR` : Erreur lors de l'upload Printify
- `RATE_LIMIT_EXCEEDED` : Limite de requ√™tes atteinte

## üåç D√©ploiement

### Docker (recommand√©)
```dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY src ./src
EXPOSE 3001
CMD ["npm", "start"]
```

### Variables d'environnement production
```bash
NODE_ENV=production
PRINTIFY_API_KEY=your_production_key
PRINTIFY_SHOP_ID=your_production_shop
CLERK_JWKS_URL=your_production_clerk_url
```

## ü§ù Int√©gration avec votre SaaS

### Frontend React/Next.js
```javascript
// hooks/usePrintifyService.js
export const usePrintifyService = () => {
  const { getToken } = useAuth(); // Clerk
  
  const uploadImage = async (imageUrl) => {
    const token = await getToken();
    const response = await fetch('/api/printify/upload', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ imageUrl })
    });
    return response.json();
  };
  
  return { uploadImage };
};
```

### Int√©gration Supabase
```javascript
// R√©cup√©rer l'URL publique d'une image IA stock√©e dans Supabase
const { data } = supabase.storage
  .from('ai-images')
  .getPublicUrl('user-123/design.png');

// L'uploader vers Printify
await uploadImage(data.publicUrl);
```

## üìû Support

- **Issues GitHub** : [Cr√©er une issue](https://github.com/your-username/printify-service-malicknnd/issues)
- **Documentation Printify** : [API Docs](https://developers.printify.com/)
- **Documentation Clerk** : [Auth Docs](https://clerk.com/docs)

## üìÑ Licence

MIT ¬© 2024 MalicknND

---

**üé® Transformez vos cr√©ations IA en produits physiques avec ce microservice pr√™t pour la production !**